apiVersion: v1
data:
  otel-collector-symbolicator-config.yaml: |
    receivers:
      otlp:
        protocols:
          http:
            endpoint: 0.0.0.0:4319
            cors:
              allowed_origins:
              - http://*
              - https://*
              allowed_headers:
              - "*"
    processors:
      imqasymbolicateprocessor:
        api_endpoint: ${env:OTEL_COLLECTOR_SYMBOLICATOR_API_HOST}/api/v1/download/mappingFiles
        enabled: true
        file_fetch_interval: 60s
        use_insecure: true
        file_base_dir: ./file
        use_atos: true
        use_proguard: true
        use_allatori: true
        use_app_suit: false
      batch:
        send_batch_size: 10000
        send_batch_max_size: 11000
        timeout: 10s

      memory_limiter:
        # 80% of maximum memory up to 2G
        limit_mib: 1500 # 25% of limit up to 2G
        spike_limit_mib: 512
        check_interval: 5s # 50% of the maximum memory
        limit_percentage: 50 # 20% of max memory usage spike expected
        spike_limit_percentage: 20

    exporters:
      clickhouse:
        endpoint: tcp://default:e0rdBg86jm@clickhouse.test.svc.cluster.local:9000
        traces_database: imqa_traces
        traces_table_name: stacktrace_symbolicated
        logs_database: imqa_logs
        logs_table_name: stacktrace_symbolicated
        table_engine:
          name: MergeTree
          params:

    service:
      telemetry:
        metrics:
          level: none
      pipelines:
        traces:
          receivers: [ otlp ]
          processors: [ memory_limiter, imqasymbolicateprocessor, batch ]
          exporters: [ clickhouse ]
        logs:
          receivers: [ otlp ]
          processors: [ memory_limiter, imqasymbolicateprocessor, batch ]
          exporters: [ clickhouse ]
kind: ConfigMap
metadata:
  annotations:
  name: otel-collector-symbolicator-config
  namespace: test
